CREATE DATABASE IF NOT EXISTS  DW_MART_BUILD

CREATE TABLE IF NOT EXISTS company_dim(
company_id   INTEGER PRIMARY KEY,
name         VARCHAR
);

CREATE TABLE IF NOT EXISTS skills_dim(
skill_id   INTEGER PRIMARY KEY,
skills      VARCHAR,
type       VARCHAR
);

CREATE TABLE IF NOT EXISTS job_postings_fact(
job_id    INTEGER PRIMARY KEY,
company_id            INTEGER,
job_title_short       VARCHAR,
job_title             VARCHAR,
job_location          VARCHAR,
job_via               VARCHAR,
job_schedule_type     VARCHAR,
job_work_from_home    VARCHAR,
search_location       VARCHAR,
job_posted_date       TIMESTAMP,
job_no_degree_mention BOOLEAN,
job_health_insurance  BOOLEAN,
job_country           VARCHAR,
salary_rate           VARCHAR,
salary_year_avg       DOUBLE,
salary_hour_avg       DOUBLE,
FOREIGN KEY(company_id) REFERENCES company_dim(company_id)
);

CREATE TABLE IF NOT EXISTS skills_job_dim(
skill_id    INTEGER,
job_id      INTEGER,
PRIMARY KEY (skill_id,job_id),
FOREIGN KEY (skill_id) REFERENCES skills_dim(skill_id),
FOREIGN KEY (job_id)   REFERENCES job_postings_fact(job_id)
);

DROP TABLE IF EXISTS skills_job_dim;
DROP TABLE IF EXISTS job_postings_fact;
DROP TABLE IF EXISTS skills_dim;
DROP TABLE IF EXISTS company_dim;


INSERT INTO  company_dim (company_id,name)
SELECT company_id,name FROM read_csv('https://storage.googleapis.com/sql_de/company_dim.csv',
AUTO_DETECT=true);

INSERT INTO  skills_dim (skill_id,skills,type)
SELECT skill_id,skills,type FROM read_csv('https://storage.googleapis.com/sql_de/skills_dim.csv',
AUTO_DETECT=true);

INSERT INTO  job_postings_fact(job_id, company_id, job_title_short, job_title, job_location, 
    job_via, job_schedule_type, job_work_from_home, search_location,
    job_posted_date, job_no_degree_mention, job_health_insurance, 
    job_country, salary_rate, salary_year_avg, salary_hour_avg)
SELECT job_id, company_id, job_title_short, job_title, job_location, 
    job_via, job_schedule_type, job_work_from_home, search_location,
    job_posted_date, job_no_degree_mention, job_health_insurance, 
    job_country, salary_rate, salary_year_avg, salary_hour_avg FROM read_csv('https://storage.googleapis.com/sql_de/job_postings_fact.csv',
    AUTO_DETECT=true);

INSERT INTO  skills_job_dim(skill_id,job_id)
SELECT skill_id,job_id FROM read_csv('https://storage.googleapis.com/sql_de/skills_job_dim.csv',
AUTO_DETECT=true);
    
